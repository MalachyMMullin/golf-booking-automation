name: Thursday golf booking - Parallel (all 6 users)

on:
  schedule:
    # 06:00 UTC Thursday = 17:00 AEST (UTC+11) / 16:00 AEDT (UTC+10)
    # Start early so all workers are logged in well before the 6:30pm draw.
    - cron: "0 6 * * 4"
  workflow_dispatch: {}

jobs:
  parallel-book:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    concurrency:
      group: golf-booking-parallel
      cancel-in-progress: true
    env:
      TZ: Australia/Sydney
      GOLFBOT_RUN_ROOT: ${{ github.workspace }}/golfbot_logs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install Chromedriver
        uses: nanasess/setup-chromedriver@v2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for Sydney login window (scheduled runs only)
        if: github.event_name == 'schedule'
        run: |
          # Wait until 18:00 Sydney time before starting login
          WINDOW_START=$((18 * 60))
          WINDOW_END=$((18 * 60 + 15))
          while true; do
            SYD_HOUR=$(TZ=Australia/Sydney date +%H)
            SYD_MIN=$(TZ=Australia/Sydney date +%M)
            SYD_TOTAL=$((10#$SYD_HOUR * 60 + 10#$SYD_MIN))
            if [ "$SYD_TOTAL" -lt "$WINDOW_START" ]; then
              REMAIN=$((WINDOW_START - SYD_TOTAL))
              SLEEP=$((REMAIN > 5 ? 300 : REMAIN * 60))
              [ "$SLEEP" -le 0 ] && SLEEP=30
              echo "Waiting for 18:00 Sydney (${SYD_HOUR}:${SYD_MIN}). Sleeping ${SLEEP}s."
              sleep "$SLEEP"
            elif [ "$SYD_TOTAL" -gt "$WINDOW_END" ]; then
              echo "Past 18:15 — proceeding immediately (${SYD_HOUR}:${SYD_MIN})."
              break
            else
              echo "In login window (${SYD_HOUR}:${SYD_MIN}) — proceeding."
              break
            fi
          done
          echo "Starting at $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: Print Chrome versions
        run: |
          google-chrome --version || true
          chromedriver --version || true

      - name: Run parallel booking script
        env:
          MIGOLF_USER_1: ${{ secrets.MIGOLF_USER_1 }}
          MIGOLF_PASS_1: ${{ secrets.MIGOLF_PASS_1 }}
          MIGOLF_USER_2: ${{ secrets.MIGOLF_USER_2 }}
          MIGOLF_PASS_2: ${{ secrets.MIGOLF_PASS_2 }}
          MIGOLF_USER_3: ${{ secrets.MIGOLF_USER_3 }}
          MIGOLF_PASS_3: ${{ secrets.MIGOLF_PASS_3 }}
          MIGOLF_USER_4: ${{ secrets.MIGOLF_USER_4 }}
          MIGOLF_PASS_4: ${{ secrets.MIGOLF_PASS_4 }}
          MIGOLF_USER_5: ${{ secrets.MIGOLF_USER_5 }}
          MIGOLF_PASS_5: ${{ secrets.MIGOLF_PASS_5 }}
          MIGOLF_USER_6: ${{ secrets.MIGOLF_USER_6 }}
          MIGOLF_PASS_6: ${{ secrets.MIGOLF_PASS_6 }}
          PYTHONUNBUFFERED: "1"
        run: python -u booking_script_parallel.py

      - name: Upload run logs and screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parallel-run-artifacts
          path: golfbot_logs/**
          if-no-files-found: ignore
